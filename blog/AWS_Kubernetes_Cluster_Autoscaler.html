<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon/favicon.ico"/><script async="" defer="" data-website-id="74444df2-7306-41d7-b127-6463fcb046c3" src="https://umami.nordictechjobs.com/umami.js"></script><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="A statically generated blog example using Next.js and Markdown."/><meta property="og:image" content="https://og-image.now.sh/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><title>How to (Cluster) Autoscale a self hosted Kubernetes on AWS EC2 | sunde.dev</title><meta property="og:image" content="/assets/blog/ec2+k8s/ec2+k8s.png"/><meta name="next-head-count" content="18"/><link rel="preload" href="/_next/static/css/1e79794c66822146.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1e79794c66822146.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-63157d71ad419e09.js" defer=""></script><script src="/_next/static/chunks/main-c59a42b9e9a6f445.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d0f99c710332dc22.js" defer=""></script><script src="/_next/static/chunks/c16184b3-4abe027722fcda81.js" defer=""></script><script src="/_next/static/chunks/956-3521b4b67ce8c4fc.js" defer=""></script><script src="/_next/static/chunks/318-a477639f2d07591e.js" defer=""></script><script src="/_next/static/chunks/770-ef4b039553301de8.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-0650e0e490cf1940.js" defer=""></script><script src="/_next/static/hgBOCi3opFfm3JozTYG_d/_buildManifest.js" defer=""></script><script src="/_next/static/hgBOCi3opFfm3JozTYG_d/_ssgManifest.js" defer=""></script><style id="__jsx-1ce0501be4d47317">h1.jsx-1ce0501be4d47317{margin-bottom:0}h1.jsx-1ce0501be4d47317:hover{cursor:pointer}nav.jsx-1ce0501be4d47317{padding:1.5rem 1.25rem;border-bottom:1px solid#ebebeb;display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-moz-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-webkit-flex-direction:row;-moz-box-orient:horizontal;-moz-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-webkit-align-items:center;-moz-box-align:center;-ms-flex-align:center;align-items:center}@media(min-width:768px){.header.jsx-1ce0501be4d47317{height:100vh;position:fixed;left:0;top:0}.nav.jsx-1ce0501be4d47317{padding:2rem;width:10vw;height:100%;border-bottom:none;-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;-moz-box-orient:vertical;-moz-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-webkit-align-items:flex-start;-moz-box-align:start;-ms-flex-align:start;align-items:flex-start}}</style></head><body><div id="__next"><div class="min-h-screen"><div class="border-b bg-accent-1 border-accent-2"><div class="md:container mx-auto px-5"><div class="py-2 text-center text-sm">The source code for this blog is<!-- --> <a href="https://github.com/persunde/persunde.github.io/" class="underline hover:text-success duration-200 transition-colors" target="_blank">available on GitHub</a></div></div></div><main><header class="jsx-1ce0501be4d47317 header"><nav role="navigation" aria-label="main navigation" class="jsx-1ce0501be4d47317 nav"><a href="/blog"><h1 class="jsx-1ce0501be4d47317">sunde.dev<!-- -->/blog</h1></a><div class="jsx-1ce0501be4d47317"><a href="/"><h1 class="jsx-1ce0501be4d47317">info</h1></a></div></nav></header><div class="md:container mx-auto px-5"><article class="mb-32"><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">How to (Cluster) Autoscale a self hosted Kubernetes on AWS EC2</h1><div class="mb-8 md:mb-16 -mx-5 sm:mx-0"><div class="-mx-5 sm:mx-0"><img src="/assets/blog/ec2+k8s/ec2+k8s.png" alt="Cover Image for How to (Cluster) Autoscale a self hosted Kubernetes on AWS EC2" class="shadow-small"/></div></div><div class="max-w-2xl block mb-6"><div class="flex items-center space-x-4 mb-2 flex-wrap"><div class="flex items-center"><img src="/assets/index/geneve-anime.jpeg" class="w-12 h-12 rounded-full mr-4" alt="Per Sunde"/><div class="text-xl font-bold">Per Sunde</div></div><div class="text-lg col-span-2 space-x-2 flex"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="calendar" class="svg-inline--fa fa-calendar w-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z"></path></svg><time dateTime="2024-04-29">April	29, 2024</time></div><div class="text-lg font-bold col-span-3 flex space-x-2"><div><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock w-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"></path></svg></div><div>8 min read</div></div><div class="flex items-center space-x-2"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag w-6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 80V229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7H48C21.5 32 0 53.5 0 80zm112 32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"></path></svg><div>Kubernets, K8S, K3S, AWS, EC2, hosting, autoscale</div></div></div></div><div class="markdown-body max-w-5xl "><h1>Autoscale K3S on AWS</h1>
<h2>TLDR</h2>
<ol>
<li>Setup the IAM configuration<!-- -->
<ol>
<li>Create an IAM Security policy</li>
<li>Create an IAM Role<!-- -->
<ol>
<li>Attach the newly created policy to this role</li>
</ol>
</li>
</ol>
</li>
<li>Setup the Control plane<!-- -->
<ol>
<li>Create one or more EC2&#x27;s<!-- -->
<ol>
<li>Set the newly created IAM Role on the EC2</li>
</ol>
</li>
<li>Install K3S<!-- -->
<ol>
<li>Make sure to include <code>INSTALL_K3S_EXEC=&quot;--kubelet-arg=provider-id=aws:///$(ec2metadata --availability-zone)/$(ec2metadata --instance-id)&quot;</code> in the installation script</li>
</ol>
</li>
</ol>
</li>
<li>Create an EC2 Auto Scaling Group (ASG)<!-- -->
<ol>
<li>Add &quot;tags&quot; on the ASG.<!-- -->
<ol>
<li>Needed so that the cluster-autoscaler identifies and uses the correct ASG.</li>
</ol>
</li>
<li>Add the &quot;user data&quot; script.<!-- -->
<ol>
<li>Will install K3S.</li>
<li>Have the EC2 automatically join the cluster as an &quot;Agent&quot;.</li>
</ol>
</li>
</ol>
</li>
<li>Deploy the cluster-autoscaler<!-- -->
<ol>
<li>Configure it to use the ASG by looking for ASG&#x27;s with the specified tags: <code>--node-group-auto-discovery=asg:tag=my-autoscaler-tag1,my-autoscaler-tag2</code></li>
</ol>
</li>
<li>Deploy a test application to test the Cluster Autoscaler</li>
</ol>
<h2>1. Setup the IAM configuration</h2>
<p>Create the <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#full-cluster-autoscaler-features-policy-recommended">Full Cluster Autoscaler Features Policy (Recommended)</a>
But remove the &quot;eks:DescribeNodegroup&quot; action, since we are not using EKS.</p>
<blockquote>
<p>NOTE: This gives all the permissions and allow it for all resources. If you want to be more restrictice, check out the <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#minimal-iam-permissions-policy">Minimal IAM Permissions Policy</a> to see how you can restrict which resources can be granted these permissions.</p>
</blockquote>
<p>Go to IAM -&gt; Policies -&gt; &quot;Create Policy&quot; -&gt; JSON and copy paste this text into the policy editor and give it a name.</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-json" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#9cdcfe">&quot;Version&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&quot;2012-10-17&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>  </span><span class="token" style="color:#9cdcfe">&quot;Statement&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#9cdcfe">&quot;Effect&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&quot;Allow&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>      </span><span class="token" style="color:#9cdcfe">&quot;Action&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:DescribeAutoScalingGroups&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:DescribeAutoScalingInstances&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:DescribeLaunchConfigurations&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:DescribeScalingActivities&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:DescribeTags&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;ec2:DescribeImages&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;ec2:DescribeInstanceTypes&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;ec2:DescribeLaunchTemplateVersions&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;ec2:GetInstanceTypesFromInstanceRequirements&quot;</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>      </span><span class="token" style="color:#9cdcfe">&quot;Resource&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;*&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#9cdcfe">&quot;Effect&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&quot;Allow&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>      </span><span class="token" style="color:#9cdcfe">&quot;Action&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:SetDesiredCapacity&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        </span><span class="token" style="color:#ce9178">&quot;autoscaling:TerminateInstanceInAutoScalingGroup&quot;</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>      </span><span class="token" style="color:#9cdcfe">&quot;Resource&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;*&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span></code></div></pre>
<p>Next create a IAM Role, give it a descriptive name, and attach this newly created policy. Or add this policy to your existing IAM Role that you use.</p>
<h2>2. Setup the Control plane</h2>
<p>Create one (or more) EC2 instance(s) that will work as your controle-plane nodes. These will not be a part of the auto-scaling.
These EC2 instances should have the &quot;IAM Role&quot; you created in the previous step.</p>
<p>Read the up to date documentation about how to setup and install K3S here: <a href="https://k3s.rocks/install-setup/">https://k3s.rocks/install-setup/</a>
Follow the guide, but when you come to the &quot;Install k3s&quot; section, instead run the command below instead.
Since we are not using EKS, we need to specify the kubelet &quot;provider-id&quot;.</p>
<p><strong>Install system dependencies:</strong></p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>sudo apt update &amp;&amp; \
</span>sudo apt upgrade -y &amp;&amp; \
<!-- -->sudo apt install -y curl  \
<!-- -->  ca-certificates \
<!-- -->  open-iscsi \
<!-- -->  wireguard \
<!-- -->  nfs-common</code></div></pre>
<p><strong>Install K3S:</strong></p>
<blockquote>
<p><strong>NOTE:</strong> Assumes you use AWS Ubuntu. If you use AWS Linux or non-debian based system, then the command <code>ec2metadata</code> might have a different name. For AWS Linux the command is <code>ec2-metadata</code>.</p>
</blockquote>
<p>Only difference between the installation command in <a href="https://k3s.rocks">https://k3s.rocks</a> and the below command is that you need to add <code>INSTALL_K3S_EXEC=&quot;--kubelet-arg=provider-id=aws:///$(ec2metadata --availability-zone)/$(ec2metadata --instance-id)&quot;</code> before <code>sh</code> to the install command!</p>
<blockquote>
<p>&quot;If you&#x27;re managing your own kubelets, they need to be started with the --provider-id flag. The provider id has the format aws:///&lt;availability-zone&gt;/&lt;instance-id&gt;, e.g. aws:///us-east-1a/i-01234abcdef.&quot;
<a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#common-notes-and-gotchas">Source</a></p>
</blockquote>
<p>Set the &quot;K3S_VERSION&quot; variable to the version you want to install. See <a href="https://k3s.rocks">https://k3s.rocks</a> for the latest version.
Optionally remove the <code>INSTALL_K3S_VERSION=$K3S_VERSION</code> part to install the latest stable version.</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>K3S_VERSION=v1.28.3+k3s2
</span>
<!-- -->curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=$K3S_VERSION INSTALL_K3S_EXEC=&quot;--kubelet-arg=provider-id=aws:///$(ec2metadata --availability-zone)/$(ec2metadata --instance-id)&quot; sh -s server \
<!-- -->--cluster-init \
<!-- -->--flannel-backend=wireguard-native \
<!-- -->--write-kubeconfig-mode 644 &amp;&amp; \
<!-- -->export KUBECONFIG=/etc/rancher/k3s/k3s.yaml &amp;&amp; \
<!-- -->cat traefik-config.yaml | envsubst | kubectl apply -f -</code></div></pre>
<h2>3. Create an EC2 Auto Scaling Group (ASG)</h2>
<blockquote>
<blockquote>
<p>Note: <strong>Cluster Autoscaler is not responsible for behaviour and registration to the cluster of the new nodes it creates.</strong> The responsibility of registering the new nodes into your cluster lies with the cluster provisioning tooling you use. Example: If you use kubeadm to provision your cluster, it is up to you to automatically execute kubeadm join at boot time via some script.</p>
</blockquote>
<p><a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-up-work">Source</a></p>
<p>It is up to you to make sure the newly created EC2 instance joins the Kubernetes cluster. That is why we add an init script to the ASG, to make sure newly added EC2 instancess install K3S and join the cluster automatically.</p>
</blockquote>
<p>Init script for Auto-Scale Group (AGS).
This will join a new agent node to the cluster.</p>
<p>Add the K3S_TOKEN and the MASTER_IP to the script.</p>
<ul>
<li>K3S_TOKEN: Run this command on one of your control-plane nodes: <code>k3s token create --ttl 0</code>
<ul>
<li>It will generate a token that will never expire, so make sure to not leak the secret!</li>
</ul>
</li>
<li>MASTER_IP: The private IP of your controle-plane instance. Found on the EC2 dashboard.</li>
</ul>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>#!/bin/bash
</span>#NOTE: Assumes you use AWS Ubuntu
<!-- -->
<!-- --># Install system dependencies
<!-- -->apt update &amp;&amp; \
<!-- -->apt upgrade -y &amp;&amp; \
<!-- -->apt install -y curl  \
<!-- -->ca-certificates \
<!-- -->open-iscsi \
<!-- -->wireguard \
<!-- -->nfs-common
<!-- -->
<!-- -->K3S_TOKEN=&quot;&lt;JOIN_TOKEN&gt;&quot;
<!-- -->MASTER_IP=&quot;&lt;CONTROL_PLANE_PRIVATE_IP&quot;
<!-- -->AVAILABILITY_ZONE=$(ec2metadata --availability-zone)
<!-- -->INSTANCE_ID=$(ec2metadata --instance-id)
<!-- -->
<!-- --># Join Agent node
<!-- -->curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.28.3+k3s2 INSTALL_K3S_EXEC=&quot;--kubelet-arg=provider-id=aws:///$AVAILABILITY_ZONE/$INSTANCE_ID&quot; K3S_TOKEN=&quot;${K3S_TOKEN}&quot; K3S_URL=https://${MASTER_IP}:6443 sh -</code></div></pre>
<h2>4. Deploy the cluster-autoscaler</h2>
<p>Clone the cluster-autoscaler repo:</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>git clone https://github.com/kubernetes/autoscaler.git
</span>cd autoscaler/cluster-autoscaler/cloudprovider/aws/</code></div></pre>
<p>Modify the example deployment file.</p>
<ol>
<li>Change the node-group-auto-discovery tags.</li>
<li>(If you do not use AWS Linux) Change the ssl-certs path<!-- -->
<ol>
<li>See <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#common-notes-and-gotchas">Common Notes and Gotchas</a></li>
</ol>
</li>
<li>Deploy the Cluster Autoscaler</li>
</ol>
<p><strong>Step 1 - Change the node-group-auto-discovery tags</strong>
Under the &quot;Deployment&quot; kind, modify the <code>&quot;--node-group-auto-discovery=asg:tag=...&quot;</code> part. Here you need to use the tags you set on your ASG. The ASG has to contain all the tags specified, but the ASG can contain additional tags, but it can not be missing any tags.</p>
<p>Example:</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-yaml" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>node</span><span class="token" style="color:#d4d4d4">-</span><span>group</span><span class="token" style="color:#d4d4d4">-</span><span>auto</span><span class="token" style="color:#d4d4d4">-</span><span>discovery=asg</span><span class="token" style="color:#d4d4d4">:</span><span>tag=k8s.io/cluster</span><span class="token" style="color:#d4d4d4">-</span><span>autoscaler/enabled</span><span class="token" style="color:#d4d4d4">,</span><span>k8s.io/cluster</span><span class="token" style="color:#d4d4d4">-</span><span>autoscaler/control</span><span class="token" style="color:#d4d4d4">-</span><span>plane1</span></code></div></pre>
<p>This one will match for an ASG that has the two tags &quot;k8s.io/cluster-autoscaler/enabled&quot; and &quot;k8s.io/cluster-autoscaler/control-plane1&quot;.</p>
<p><strong>Step 2 - Change the ssl-certs path</strong></p>
<blockquote>
<p>NOTE: If you use Ubuntu or something other than AWS Linux, you need to modify this part.</p>
</blockquote>
<p>In the file <code>examples/cluster-autoscaler-autodiscover.yaml</code> under the cluster-autoscaler deployment, change the ssl-certs volume.</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-yaml" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#6a9955">## From this</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">volumes</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token key" style="color:#ce9178">name</span><span class="token" style="color:#d4d4d4">:</span><span> ssl</span><span class="token" style="color:#d4d4d4">-</span><span>certs
</span><span>          </span><span class="token key" style="color:#ce9178">hostPath</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token key" style="color:#ce9178">path</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&quot;/etc/ssl/certs/ca-bundle.crt&quot;</span><span>
</span>
<span></span><span class="token" style="color:#6a9955">## To this</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">volumes</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token key" style="color:#ce9178">name</span><span class="token" style="color:#d4d4d4">:</span><span> ssl</span><span class="token" style="color:#d4d4d4">-</span><span>certs
</span><span>          </span><span class="token key" style="color:#ce9178">hostPath</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token key" style="color:#ce9178">path</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&quot;/etc/ssl/certs/ca-certificates.crt&quot;</span></code></div></pre>
<p><strong>Step 3 - Deploy the Cluster Autoscaler</strong>
Apply the autoscaler deployment:</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>kubectl apply -f examples/cluster-autoscaler-autodiscover.yaml</span></code></div></pre>
<p>Now the auto-scaler should be deployed. Check that it works by running</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>kubectl get pods -A
</span># or
<!-- -->kubectl get pods -n=kube-system</code></div></pre>
<p>Get the pod ID, and check the logs</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>kubectl logs cluster-autoscaler-&lt;ID&gt; -n=kube-system</span></code></div></pre>
<p>Or check the description and see if there are any issues with deploying the pod:</p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-sh" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>kubectl describe pod cluster-autoscaler-&lt;ID&gt; --namespace=kube-system</span></code></div></pre>
<h2>5. Test the autoscaling</h2>
<p>Deploy a test deployment that you can use to see if the autoscaler works or not:</p>
<p>Save the file as <code>hello-world.yaml</code> and deploy it <code>kubectl apply -f hello-world.yaml</code></p>
<pre><div style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code class="language-yaml" style="color:#d4d4d4;font-size:16px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token key" style="color:#ce9178">apiVersion</span><span class="token" style="color:#d4d4d4">:</span><span> apps/v1
</span><span></span><span class="token key" style="color:#ce9178">kind</span><span class="token" style="color:#d4d4d4">:</span><span> Deployment
</span><span></span><span class="token key" style="color:#ce9178">metadata</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>  </span><span class="token key" style="color:#ce9178">labels</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token key" style="color:#ce9178">app</span><span class="token" style="color:#d4d4d4">:</span><span> hello</span><span class="token" style="color:#d4d4d4">-</span><span>world
</span><span>  </span><span class="token key" style="color:#ce9178">name</span><span class="token" style="color:#d4d4d4">:</span><span> hello</span><span class="token" style="color:#d4d4d4">-</span><span>world
</span><span></span><span class="token key" style="color:#ce9178">spec</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>  </span><span class="token key" style="color:#ce9178">replicas</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">4</span><span>
</span><span>  </span><span class="token key" style="color:#ce9178">selector</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token key" style="color:#ce9178">matchLabels</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">app</span><span class="token" style="color:#d4d4d4">:</span><span> hello</span><span class="token" style="color:#d4d4d4">-</span><span>world
</span><span>  </span><span class="token key" style="color:#ce9178">strategy</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token key" style="color:#ce9178">rollingUpdate</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">maxSurge</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">1</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">maxUnavailable</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0</span><span>
</span><span>    </span><span class="token key" style="color:#ce9178">type</span><span class="token" style="color:#d4d4d4">:</span><span> RollingUpdate
</span><span>  </span><span class="token key" style="color:#ce9178">template</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token key" style="color:#ce9178">metadata</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">labels</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token key" style="color:#ce9178">app</span><span class="token" style="color:#d4d4d4">:</span><span> hello</span><span class="token" style="color:#d4d4d4">-</span><span>world
</span><span>    </span><span class="token key" style="color:#ce9178">spec</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>      </span><span class="token key" style="color:#ce9178">containers</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">-</span><span> </span><span class="token key" style="color:#ce9178">name</span><span class="token" style="color:#d4d4d4">:</span><span> ubuntu
</span><span>        </span><span class="token key" style="color:#ce9178">image</span><span class="token" style="color:#d4d4d4">:</span><span> ubuntu</span><span class="token" style="color:#d4d4d4">:</span><span>latest
</span><span>        </span><span class="token" style="color:#6a9955"># Prints &quot;HELLO WORLD&quot; every 30 seconds</span><span>
</span><span>        </span><span class="token key" style="color:#ce9178">command</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span> </span><span class="token" style="color:#ce9178">&quot;/bin/bash&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;-c&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;--&quot;</span><span> </span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>        </span><span class="token key" style="color:#ce9178">args</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span> </span><span class="token" style="color:#ce9178">&quot;while true; do echo &#x27;HELLO WORLD&#x27; &amp;&amp; sleep 30; done;&quot;</span><span> </span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>        </span><span class="token key" style="color:#ce9178">resources</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>          </span><span class="token key" style="color:#ce9178">limits</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token key" style="color:#ce9178">cpu</span><span class="token" style="color:#d4d4d4">:</span><span> 500m
</span><span>            </span><span class="token key" style="color:#ce9178">memory</span><span class="token" style="color:#d4d4d4">:</span><span> 512Mi
</span><span>          </span><span class="token key" style="color:#ce9178">requests</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token key" style="color:#ce9178">cpu</span><span class="token" style="color:#d4d4d4">:</span><span> 500m
</span><span>            </span><span class="token key" style="color:#ce9178">memory</span><span class="token" style="color:#d4d4d4">:</span><span> 512Mi</span></code></div></pre>
<p>The autoscaler will check every 10 second if it needs to scale up or down or do nothing.
Check the ASG on the AWS EC2 dashboard, and see if the desired count is changed or not.</p>
<blockquote>
<p><strong>NOTE:</strong> Make sure your &quot;Maximum capacity&quot; in the ASG is set above 0 so that it can scale up. The Cluster Autoscaler will not scale over or under the maximum or minimum number you set in the ASG.</p>
</blockquote>
<p>Change the number of replicas in the <code>hello-world.yaml</code> and apply the file again to see the autoscaler start to scale up or down.
Note that the default time to scale down is 10 minutes after node has been marked for removal. After 10 minutes, if the node is still ok to be removed the Cluster Autoscaler will terminate the EC2 instance.</p>
<p>Read the <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md">AWS Autoscaler README</a> for how you can change the parameters for the cluster autoscaler that was deployed using the <code>examples/cluster-autoscaler-autodiscover.yaml</code> file.</p>
<h2>NOTES</h2>
<ul>
<li>
<p>The Cluster Autoscaler &quot;does not delete the Node object from Kubernetes.&quot;</p>
<blockquote>
<p>How does Cluster Autoscaler remove nodes?</p>
<p>Cluster Autoscaler terminates the underlying instance in a cloud-provider-dependent manner.</p>
<p>It does not delete the Node object from Kubernetes. Cleaning up Node objects corresponding to terminated instances is the responsibility of the cloud node controller, which can run as part of kube-controller-manager or cloud-controller-manager.</p>
<p><a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-cluster-autoscaler-remove-nodes">Source</a></p>
</blockquote>
</li>
<li>
<p>If you want to delete the &quot;Node object&quot; you can either use your own bash script or similar, or run the <a href="https://cloud-provider-aws.sigs.k8s.io/">AWS cloud provider</a>
Or make your own Operator that automatically does this for you.</p>
<ul>
<li>Example bash script: <code>kubectl delete node $(kubectl get nodes | grep NotReady | awk &#x27;{print $1;}&#x27;)</code>
<ul>
<li><a href="https://stackoverflow.com/a/68001385/15137927">Source</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>There are lots of details you should be aware of in a production setting. Be sure to read the Cluster Autoscaler <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md">FAQ</a> and the <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md">AWS README</a>.</p></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="md:container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><h3 class="text-4xl lg:text-5xl font-bold tracking-tighter leading-tight text-center lg:text-left mb-10 lg:mb-0 lg:pr-4 lg:w-1/2">If you are not sure which beer is yours, it is the one with the most in it</h3><div class="flex flex-col lg:flex-row justify-center items-center lg:pl-4 lg:w-1/2"><a href="https://github.com/persunde/" class="mx-3 font-bold hover:underline">Check out my GitHub</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"How to (Cluster) Autoscale a self hosted Kubernetes on AWS EC2","date":"2024-04-29","slug":"AWS_Kubernetes_Cluster_Autoscaler","author":"Per Sunde","content":"\n# Autoscale K3S on AWS\n\n## TLDR\n\n1. Setup the IAM configuration\n   1. Create an IAM Security policy\n   2. Create an IAM Role\n      1. Attach the newly created policy to this role\n2. Setup the Control plane\n   1. Create one or more EC2's\n      1. Set the newly created IAM Role on the EC2\n   2. Install K3S\n      1. Make sure to include `INSTALL_K3S_EXEC=\"--kubelet-arg=provider-id=aws:///$(ec2metadata --availability-zone)/$(ec2metadata --instance-id)\"` in the installation script\n3. Create an EC2 Auto Scaling Group (ASG)\n   1. Add \"tags\" on the ASG.\n      1. Needed so that the cluster-autoscaler identifies and uses the correct ASG.\n   2. Add the \"user data\" script.\n      1. Will install K3S.\n      2. Have the EC2 automatically join the cluster as an \"Agent\".\n4. Deploy the cluster-autoscaler\n   1. Configure it to use the ASG by looking for ASG's with the specified tags: `--node-group-auto-discovery=asg:tag=my-autoscaler-tag1,my-autoscaler-tag2`\n5. Deploy a test application to test the Cluster Autoscaler\n\n## 1. Setup the IAM configuration\n\nCreate the [Full Cluster Autoscaler Features Policy (Recommended)](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#full-cluster-autoscaler-features-policy-recommended)\nBut remove the \"eks:DescribeNodegroup\" action, since we are not using EKS.\n\n\u003eNOTE: This gives all the permissions and allow it for all resources. If you want to be more restrictice, check out the [Minimal IAM Permissions Policy](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#minimal-iam-permissions-policy) to see how you can restrict which resources can be granted these permissions.\n\nGo to IAM -\u003e Policies -\u003e \"Create Policy\" -\u003e JSON and copy paste this text into the policy editor and give it a name.\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"autoscaling:DescribeAutoScalingGroups\",\n        \"autoscaling:DescribeAutoScalingInstances\",\n        \"autoscaling:DescribeLaunchConfigurations\",\n        \"autoscaling:DescribeScalingActivities\",\n        \"autoscaling:DescribeTags\",\n        \"ec2:DescribeImages\",\n        \"ec2:DescribeInstanceTypes\",\n        \"ec2:DescribeLaunchTemplateVersions\",\n        \"ec2:GetInstanceTypesFromInstanceRequirements\"\n      ],\n      \"Resource\": [\"*\"]\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"autoscaling:SetDesiredCapacity\",\n        \"autoscaling:TerminateInstanceInAutoScalingGroup\"\n      ],\n      \"Resource\": [\"*\"]\n    }\n  ]\n}\n```\n\nNext create a IAM Role, give it a descriptive name, and attach this newly created policy. Or add this policy to your existing IAM Role that you use.\n\n## 2. Setup the Control plane\n\nCreate one (or more) EC2 instance(s) that will work as your controle-plane nodes. These will not be a part of the auto-scaling.\nThese EC2 instances should have the \"IAM Role\" you created in the previous step.\n\nRead the up to date documentation about how to setup and install K3S here: \u003chttps://k3s.rocks/install-setup/\u003e\nFollow the guide, but when you come to the \"Install k3s\" section, instead run the command below instead.\nSince we are not using EKS, we need to specify the kubelet \"provider-id\".\n\n\n**Install system dependencies:**\n\n```sh\nsudo apt update \u0026\u0026 \\\nsudo apt upgrade -y \u0026\u0026 \\\nsudo apt install -y curl  \\\n  ca-certificates \\\n  open-iscsi \\\n  wireguard \\\n  nfs-common\n```\n\n**Install K3S:**\n\n\u003e**NOTE:** Assumes you use AWS Ubuntu. If you use AWS Linux or non-debian based system, then the command `ec2metadata` might have a different name. For AWS Linux the command is `ec2-metadata`.\n\nOnly difference between the installation command in \u003chttps://k3s.rocks\u003e and the below command is that you need to add `INSTALL_K3S_EXEC=\"--kubelet-arg=provider-id=aws:///$(ec2metadata --availability-zone)/$(ec2metadata --instance-id)\"` before `sh` to the install command!\n\n\u003e\"If you're managing your own kubelets, they need to be started with the --provider-id flag. The provider id has the format aws:///\\\u003cavailability-zone\u003e/\\\u003cinstance-id\u003e, e.g. aws:///us-east-1a/i-01234abcdef.\"\n\u003e[Source](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#common-notes-and-gotchas)\n\nSet the \"K3S_VERSION\" variable to the version you want to install. See \u003chttps://k3s.rocks\u003e for the latest version.\nOptionally remove the `INSTALL_K3S_VERSION=$K3S_VERSION` part to install the latest stable version.\n\n```sh\nK3S_VERSION=v1.28.3+k3s2\n\ncurl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=$K3S_VERSION INSTALL_K3S_EXEC=\"--kubelet-arg=provider-id=aws:///$(ec2metadata --availability-zone)/$(ec2metadata --instance-id)\" sh -s server \\\n--cluster-init \\\n--flannel-backend=wireguard-native \\\n--write-kubeconfig-mode 644 \u0026\u0026 \\\nexport KUBECONFIG=/etc/rancher/k3s/k3s.yaml \u0026\u0026 \\\ncat traefik-config.yaml | envsubst | kubectl apply -f -\n```\n\n## 3. Create an EC2 Auto Scaling Group (ASG)\n\n\u003e \u003eNote: **Cluster Autoscaler is not responsible for behaviour and registration to the cluster of the new nodes it creates.** The responsibility of registering the new nodes into your cluster lies with the cluster provisioning tooling you use. Example: If you use kubeadm to provision your cluster, it is up to you to automatically execute kubeadm join at boot time via some script.\n\u003e\n\u003e[Source](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-up-work)\n\u003e\n\u003eIt is up to you to make sure the newly created EC2 instance joins the Kubernetes cluster. That is why we add an init script to the ASG, to make sure newly added EC2 instancess install K3S and join the cluster automatically.\n\nInit script for Auto-Scale Group (AGS).\nThis will join a new agent node to the cluster.\n\nAdd the K3S_TOKEN and the MASTER_IP to the script.\n\n- K3S_TOKEN: Run this command on one of your control-plane nodes: `k3s token create --ttl 0`\n  - It will generate a token that will never expire, so make sure to not leak the secret!\n- MASTER_IP: The private IP of your controle-plane instance. Found on the EC2 dashboard.\n\n```sh\n#!/bin/bash\n#NOTE: Assumes you use AWS Ubuntu\n\n# Install system dependencies\napt update \u0026\u0026 \\\napt upgrade -y \u0026\u0026 \\\napt install -y curl  \\\nca-certificates \\\nopen-iscsi \\\nwireguard \\\nnfs-common\n\nK3S_TOKEN=\"\u003cJOIN_TOKEN\u003e\"\nMASTER_IP=\"\u003cCONTROL_PLANE_PRIVATE_IP\"\nAVAILABILITY_ZONE=$(ec2metadata --availability-zone)\nINSTANCE_ID=$(ec2metadata --instance-id)\n\n# Join Agent node\ncurl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.28.3+k3s2 INSTALL_K3S_EXEC=\"--kubelet-arg=provider-id=aws:///$AVAILABILITY_ZONE/$INSTANCE_ID\" K3S_TOKEN=\"${K3S_TOKEN}\" K3S_URL=https://${MASTER_IP}:6443 sh -\n```\n\n## 4. Deploy the cluster-autoscaler\n\nClone the cluster-autoscaler repo:\n\n```sh\ngit clone https://github.com/kubernetes/autoscaler.git\ncd autoscaler/cluster-autoscaler/cloudprovider/aws/\n```\n\nModify the example deployment file.\n\n1. Change the node-group-auto-discovery tags.\n2. (If you do not use AWS Linux) Change the ssl-certs path\n   1. See [Common Notes and Gotchas](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#common-notes-and-gotchas)\n3. Deploy the Cluster Autoscaler\n\n**Step 1 - Change the node-group-auto-discovery tags**\nUnder the \"Deployment\" kind, modify the `\"--node-group-auto-discovery=asg:tag=...\"` part. Here you need to use the tags you set on your ASG. The ASG has to contain all the tags specified, but the ASG can contain additional tags, but it can not be missing any tags.\n\nExample:\n\n```yaml\n--node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/control-plane1\n```\n\nThis one will match for an ASG that has the two tags \"k8s.io/cluster-autoscaler/enabled\" and \"k8s.io/cluster-autoscaler/control-plane1\".\n\n**Step 2 - Change the ssl-certs path**\n\u003eNOTE: If you use Ubuntu or something other than AWS Linux, you need to modify this part.\n\nIn the file `examples/cluster-autoscaler-autodiscover.yaml` under the cluster-autoscaler deployment, change the ssl-certs volume.\n\n```yaml\n## From this\n      volumes:\n        - name: ssl-certs\n          hostPath:\n            path: \"/etc/ssl/certs/ca-bundle.crt\"\n\n## To this\n      volumes:\n        - name: ssl-certs\n          hostPath:\n            path: \"/etc/ssl/certs/ca-certificates.crt\"\n```\n\n**Step 3 - Deploy the Cluster Autoscaler**\nApply the autoscaler deployment:\n\n```sh\nkubectl apply -f examples/cluster-autoscaler-autodiscover.yaml\n```\n\nNow the auto-scaler should be deployed. Check that it works by running\n\n```sh\nkubectl get pods -A\n# or\nkubectl get pods -n=kube-system\n```\n\nGet the pod ID, and check the logs\n\n```sh\nkubectl logs cluster-autoscaler-\u003cID\u003e -n=kube-system\n```\n\nOr check the description and see if there are any issues with deploying the pod:\n\n```sh\nkubectl describe pod cluster-autoscaler-\u003cID\u003e --namespace=kube-system\n```\n\n## 5. Test the autoscaling\n\nDeploy a test deployment that you can use to see if the autoscaler works or not:\n\nSave the file as `hello-world.yaml` and deploy it `kubectl apply -f hello-world.yaml`\n\n```yaml hello-world.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: hello-world\n  name: hello-world\nspec:\n  replicas: 4\n  selector:\n    matchLabels:\n      app: hello-world\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: hello-world\n    spec:\n      containers:\n      - name: ubuntu\n        image: ubuntu:latest\n        # Prints \"HELLO WORLD\" every 30 seconds\n        command: [ \"/bin/bash\", \"-c\", \"--\" ]\n        args: [ \"while true; do echo 'HELLO WORLD' \u0026\u0026 sleep 30; done;\" ]\n        resources:\n          limits:\n            cpu: 500m\n            memory: 512Mi\n          requests:\n            cpu: 500m\n            memory: 512Mi\n```\n\nThe autoscaler will check every 10 second if it needs to scale up or down or do nothing.\nCheck the ASG on the AWS EC2 dashboard, and see if the desired count is changed or not.\n\n\u003e**NOTE:** Make sure your \"Maximum capacity\" in the ASG is set above 0 so that it can scale up. The Cluster Autoscaler will not scale over or under the maximum or minimum number you set in the ASG.\n\nChange the number of replicas in the `hello-world.yaml` and apply the file again to see the autoscaler start to scale up or down.\nNote that the default time to scale down is 10 minutes after node has been marked for removal. After 10 minutes, if the node is still ok to be removed the Cluster Autoscaler will terminate the EC2 instance.\n\nRead the [AWS Autoscaler README](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md) for how you can change the parameters for the cluster autoscaler that was deployed using the `examples/cluster-autoscaler-autodiscover.yaml` file.\n\n## NOTES\n\n- The Cluster Autoscaler \"does not delete the Node object from Kubernetes.\"\n  \u003eHow does Cluster Autoscaler remove nodes?\n  \u003e\n  \u003eCluster Autoscaler terminates the underlying instance in a cloud-provider-dependent manner.\n  \u003e\n  \u003eIt does not delete the Node object from Kubernetes. Cleaning up Node objects corresponding to terminated instances is the responsibility of the cloud node controller, which can run as part of kube-controller-manager or cloud-controller-manager.\n  \u003e\n  \u003e[Source](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-cluster-autoscaler-remove-nodes)\n\n- If you want to delete the \"Node object\" you can either use your own bash script or similar, or run the [AWS cloud provider](https://cloud-provider-aws.sigs.k8s.io/)\nOr make your own Operator that automatically does this for you.\n  - Example bash script: `kubectl delete node $(kubectl get nodes | grep NotReady | awk '{print $1;}')` \n    - [Source](https://stackoverflow.com/a/68001385/15137927)\n\nThere are lots of details you should be aware of in a production setting. Be sure to read the Cluster Autoscaler [FAQ](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md) and the [AWS README](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md).\n\n","featuredImage":"/assets/blog/ec2+k8s/ec2+k8s.png","readingTime":"8 min read","tags":"Kubernets, K8S, K3S, AWS, EC2, hosting, autoscale"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"AWS_Kubernetes_Cluster_Autoscaler"},"buildId":"hgBOCi3opFfm3JozTYG_d","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>